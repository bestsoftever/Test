name: Publish NuGet Packages

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  publish:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Display PR info
        run: |
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "Source Branch: ${{ github.head_ref }}"
          echo "Target Branch: ${{ github.base_ref }}"
          echo "Merge Commit: ${{ github.sha }}"

      - name: Determine version bump from branch name
        id: bump
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Source branch: $BRANCH"
          
          if [[ "$BRANCH" =~ ^(breaking|major)[/-] ]]; then
            echo "increment=Major" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" =~ ^(feat|feature)[/-] ]]; then
            echo "increment=Minor" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" =~ ^(fix|bugfix|patch)[/-] ]]; then
            echo "increment=Patch" >> $GITHUB_OUTPUT
          else
            echo "increment=Patch" >> $GITHUB_OUTPUT
            echo "Branch doesn't match pattern, defaulting to Patch"
          fi
        shell: bash

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4
        with:
          overrideConfig: |
            branches:
              master:
                increment: ${{ steps.bump.outputs.increment }}

      - name: Display Version
        run: |
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "Increment: ${{ steps.bump.outputs.increment }}"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # - name: Restore dependencies
      #   run: dotnet restore

      # - name: Build
      #   run: dotnet build --configuration Release --no-restore -p:Version=${{ steps.gitversion.outputs.semVer }}

      # - name: Run tests
      #   run: dotnet test --configuration Release --no-build

      # - name: Pack NuGet packages
      #   run: dotnet pack --configuration Release --no-build -p:PackageVersion=${{ steps.gitversion.outputs.semVer }} -o ./artifacts

      - name: List artifacts (debug)
        run: ls -la ./artifacts

      # - name: Publish to NuGet.org
      #   env:
      #     NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      #   run: |
      #     echo "Pushing packages to NuGet.org..."
      #     dotnet nuget push "./artifacts/*.nupkg" --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Create and push git tag
        run: |
          TAG="v${{ steps.gitversion.outputs.semVer }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created and pushed tag: $TAG"
